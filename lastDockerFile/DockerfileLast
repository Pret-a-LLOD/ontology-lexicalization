FROM maven:3.8-jdk-11 AS buildweb

ADD pom.xml /source/pom.xml
RUN cd /source && mvn verify clean --fail-never

ADD ./src /source/src
RUN cd /source && mvn -B package -DskipTests

FROM maven:3.8-jdk-11 AS buildconv


FROM buildpack-deps:buster
LABEL maintainer="Peter Martini <PeterCMartini@GMail.com>, Zak B. Elep <zakame@cpan.org>"

COPY *.patch /usr/src/perl/
WORKDIR /app

RUN true \
    && curl -SL https://www.cpan.org/src/5.0/perl-5.34.0.tar.xz -o perl-5.34.0.tar.xz \
    && echo '82c2e5e5c71b0e10487a80d79140469ab1f8056349ca8545140a224dbbed7ded *perl-5.34.0.tar.xz' | sha256sum -c - \
    && tar --strip-components=1 -xaf perl-5.34.0.tar.xz -C /usr/src/perl \
    && rm perl-5.34.0.tar.xz \
    && cat *.patch | patch -p1 \
    && gnuArch="$(dpkg-architecture --query DEB_BUILD_GNU_TYPE)" \
    && archBits="$(dpkg-architecture --query DEB_BUILD_ARCH_BITS)" \
    && archFlag="$([ "$archBits" = '64' ] && echo '-Duse64bitall' || echo '-Duse64bitint')" \
    && ./Configure -Darchname="$gnuArch" "$archFlag" -Duseshrplib -Dvendorprefix=/usr/local  -des \
    && make -j$(nproc) \
    && TEST_JOBS=$(nproc) make test_harness \
    && make install \
    && cd /usr/src \
    && curl -LO https://www.cpan.org/authors/id/M/MI/MIYAGAWA/App-cpanminus-1.7044.tar.gz \
    && echo '9b60767fe40752ef7a9d3f13f19060a63389a5c23acc3e9827e19b75500f81f3 *App-cpanminus-1.7044.tar.gz' | sha256sum -c - \
    && tar -xzf App-cpanminus-1.7044.tar.gz && cd App-cpanminus-1.7044 && perl bin/cpanm . && cd /root \
    && true \
    && rm -fr ./cpanm /root/.cpanm /usr/src/perl /usr/src/App-cpanminus-1.7044* /tmp/*


#FROM ubuntu:bionic

#ENV TERM xterm
#ENV DEBIAN_FRONTEND noninteractive

#RUN apt-get update && apt-get install -y \
#    acedb-other-dotter \
#    build-essential \
#    bzip2 \
#    cpanminus

#RUN  apt-get update \
#  && apt-get install -y wget \
#  && rm -rf /var/lib/apt/lists/*

#FROM centos:centos7
#  RUN  yum -y install cpanm gcc perl perl-App-cpanminus perl-Config-Tiny &&  yum clean all
#  RUN cpanm install Some::Module; rm -fr root/.cpanm; exit 0

# accepts Microsoft EULA agreement without prompting
# view EULA at http://wwww.microsoft.com/typography/fontpack/eula.htm
# RUN { echo ttf-mscorefonts-installer msttcorefonts/accepted-mscorefonts-eula select true; } | debconf-set-selections \
#    && apt-get update && apt-get install -y ttf-mscorefonts-installer


#RUN export PERL5LIB=.:$PERL5LIB && \
#    cpanm \
#    Archive::Zip \
#    BSD::Resource \
#    YAML::Syck \
#    URL::Encode \
#    Text::CSV \
#    Number::Bytes::Human \
#    IO::Uncompress::Bunzip2

FROM openjdk:11.0.7


EXPOSE 8080
USER root

# WORKDIR /app
COPY ./ /app
RUN chmod +x /app
COPY ./openapi.yaml /openapi.yaml
#COPY ./data-v4  /data-v4

CMD ["java","-jar","target/rest-service-0.0.1-SNAPSHOT.jar"]

